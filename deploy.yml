version: "3.3"
services:
  gateway:
    image: openfaas/gateway:0.14.4
    ports:
      - 8080:8080
    networks:
      - functions
    environment:
      functions_provider_url: "http://faas-swarm:8080/"
      read_timeout: "300s"        # Maximum time to read HTTP request
      write_timeout: "300s"        # Maximum time to write HTTP response
      upstream_timeout: "300s"     # Maximum duration of upstream function call - should be more than read_timeout and write_timeout
      dnsrr: "true"               # Temporarily use dnsrr in place of VIP while issue persists on PWD
      faas_nats_address: "nats"
      faas_nats_port: 4222
      direct_functions: "true"    # Functions are invoked directly over the overlay network
      direct_functions_suffix: ""
      basic_auth: "${BASIC_AUTH:-true}"
      secret_mount_path: "/run/secrets/"
      scale_from_zero: "false"
    deploy:
      resources:
        # limits:   # Enable if you want to limit memory usage
        #     memory: 200M
        reservations:
          memory: 100M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 20
        window: 380s
      placement:
        constraints:
          - 'node.platform.os == linux'
    secrets:
      - basic-auth-user
      - basic-auth-password

  # Docker Swarm provider
  faas-swarm:
    image:  openfaas/faas-swarm:0.6.2
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - functions
    environment:
      read_timeout:  "300s"   # set both here, and on your functions
      write_timeout: "300s"   # set both here, and on your functions
      DOCKER_API_VERSION: "1.30"
      basic_auth: "${BASIC_AUTH:-true}"
      secret_mount_path: "/run/secrets/"
    deploy:
      placement:
        constraints:
          - 'node.role == manager'
          - 'node.platform.os == linux'
      resources:
        # limits:   # Enable if you want to limit memory usage
        #     memory: 100M
        reservations:
          memory: 100M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 20
        window: 380s
    secrets:
      - basic-auth-user
      - basic-auth-password

  nats:
    image: nats-streaming:0.11.2
    # Uncomment the following port mappings if you wish to expose the
    # NATS client and/or management ports you must also add `-m 8222` to the command
    # ports:
    #     - 4222:4222
    #     - 8222:8222
    command: "--store memory --cluster_id faas-cluster"
    networks:
      - functions
    deploy:
      resources:
        limits:
          memory: 125M
        reservations:
          memory: 50M
      placement:
        constraints:
          - 'node.platform.os == linux'

  queue-worker:
    image: openfaas/queue-worker:0.7.2
    networks:
      - functions
    environment:
      max_inflight: "1"
      ack_wait: "300s"    # Max duration of any async task / request
      basic_auth: "${BASIC_AUTH:-true}"
      secret_mount_path: "/run/secrets/"
    deploy:
      resources:
        limits:
          memory: 50M
        reservations:
          memory: 20M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 20
        window: 380s
      placement:
        constraints:
          - 'node.platform.os == linux'
    secrets:
      - basic-auth-user
      - basic-auth-password

  # End services

  # Start monitoring

  prometheus:
    image: prom/prometheus:v2.10.0
    environment:
      no_proxy: "gateway"
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
      - source: prometheus_rules
        target: /etc/prometheus/alert.rules.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    #   - '-storage.local.path=/prometheus'
    ports:
      - 9090:9090
    networks:
      - functions
    deploy:
      placement:
        constraints:
          - 'node.role == manager'
          - 'node.platform.os == linux'
      resources:
        limits:
          memory: 500M
        reservations:
          memory: 200M

  alertmanager:
    image: prom/alertmanager:v0.17.0
    environment:
      no_proxy: "gateway"
    command:
      - '--config.file=/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - functions
    deploy:
      resources:
        limits:
          memory: 50M
        reservations:
          memory: 20M
      placement:
        constraints:
          - 'node.role == manager'
          - 'node.platform.os == linux'
    configs:
      - source: alertmanager_config
        target: /alertmanager.yml

  zookeeper:
    image: confluentinc/cp-zookeeper:${CONFLUENT_PLATFORM_VERSION:-5.2.2}
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - functions
    ports:
      - 2181:2181

  kafka:
    image: confluentinc/cp-kafka:${CONFLUENT_PLATFORM_VERSION:-5.2.2}
    depends_on:
      - zookeeper
    hostname: kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://${KAFKA_PUBLIC_HOSTNAME:-localhost}:29092 # https://github.com/confluentinc/schema-registry/issues/648, https://github.com/openfaas-incubator/kafka-connector/pull/30
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
     - 29092:29092
    networks:
      - functions

  kafka-rest:
    image: confluentinc/cp-kafka-rest:${CONFLUENT_PLATFORM_VERSION:-5.2.2}
    depends_on:
      - kafka
      - schema-registry
      - zookeeper
    hostname: kafka-rest
    environment:
      ACCESS_CONTROL_ALLOW_ORIGIN_DEFAULT: '*'
      KAFKA_REST_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_REST_LISTENERS: http://0.0.0.0:8082
      KAFKA_REST_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      KAFKA_REST_HOST_NAME: kafka-rest
    ports:
      - 8082:8082
    networks:
      - functions

  schema-registry:
    image: confluentinc/cp-schema-registry:${CONFLUENT_PLATFORM_VERSION:-5.2.2}
    hostname: schema-registry
    environment:
      SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL: zookeeper:2181
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
    networks:
      - functions

  kafka-topics-ui:
    image: landoop/kafka-topics-ui:0.9.4
    depends_on:
      - kafka-rest
    environment:
      - KAFKA_REST_PROXY_URL=http://kafka-rest:8082
      - PROXY=true
    ports:
      - 8001:8000
    networks:
      - functions

  connector:
    image: openfaas/kafka-connector:0.3.4
    hostname: kafka-connector
    environment:
      gateway_url: http://gateway:8080
      topics: "faas-request,mobile,sensor,"
      print_response: "true"
      print_response_body: "true"
      basic_auth: "true"
      secret_mount_path: "/run/secrets/"
    secrets:
      - basic-auth-password
      - basic-auth-user
    networks:
      - functions

  mongo:
    image: mongo
    hostname: mongo
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: root
      MONGO_INITDB_DATABASE: sensor
      MONGO_HOST: mongo
    networks:
      - functions

  mongo-express:
    image: mongo-express
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
    networks:
      - functions

configs:
  prometheus_config:
    file: ./prometheus/prometheus.yml
  prometheus_rules:
    file: ./prometheus/alert.rules.yml
  alertmanager_config:
    file: ./prometheus/alertmanager.yml

networks:
  functions:
    driver: overlay
    attachable: true
    labels:
      - "openfaas=true"

secrets:
  basic-auth-user:
    external: true
  basic-auth-password:
    external: true
